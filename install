#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TARGET_DIR="$HOME/.config/opencode"
BACKUP_ROOT="$HOME/.config/opencode.backups"
TIMESTAMP="$(date -u +%Y%m%d%H%M%SZ)"
BACKUP_PATH="$BACKUP_ROOT/opencode-$TIMESTAMP"
REMOTE_MANIFEST="https://raw.githubusercontent.com/krajh/ai-kit/main/README.md"
RC_FILE=""

DRY_RUN=false
VALIDATE_REMOTE=false
UPDATE_MODE=false

log() {
  printf "[install] %s\n" "$*"
}

parse_args() {
  while [ "$#" -gt 0 ]; do
    case "$1" in
      --dry-run)
        DRY_RUN=true
        shift
        ;;
      --validate-remote)
        VALIDATE_REMOTE=true
        shift
        ;;
      --update)
        UPDATE_MODE=true
        shift
        ;;
      *)
        log "Unknown option: $1"
        exit 1
        ;;
    esac
  done
}

detect_shell_rcfile() {
  if [ -n "${ZSH_VERSION:-}" ] || [ "$SHELL" = "$(command -v zsh)" ]; then
    RC_FILE="$HOME/.zshrc"
  elif [ -n "${BASH_VERSION:-}" ] || [ "$SHELL" = "$(command -v bash)" ]; then
    RC_FILE="$HOME/.bashrc"
  else
    log "Could not detect shell type. Defaulting to .bashrc"
    RC_FILE="$HOME/.bashrc"
  fi
  log "Detected shell RC file: $RC_FILE"
}

ensure_aio_key() {
  if [ "$DRY_RUN" = true ]; then
    log "Dry run: skipping AITOOLINGKEY prompt."
    return
  fi

  if grep -q "export AITOOLINGKEY=" "$RC_FILE" 2>/dev/null; then
    log "AITOOLINGKEY already configured in $RC_FILE"
    return
  fi

  log "AITOOLINGKEY not found in $RC_FILE"
  printf "Enter your AITOOLINGKEY (or press Enter to skip): "
  read -r aio_key

  if [ -z "$aio_key" ]; then
    log "Skipping AITOOLINGKEY configuration."
    return
  fi

  echo "" >> "$RC_FILE"
  echo "# OpenCode Corporate Kit - AITooling API Key" >> "$RC_FILE"
  echo "export AITOOLINGKEY=\"$aio_key\"" >> "$RC_FILE"
  log "AITOOLINGKEY added to $RC_FILE"
  log "Run 'source $RC_FILE' or restart your shell to apply."
}

ensure_opencode_cli() {
  if command -v opencode >/dev/null 2>&1; then
    log "OpenCode CLI already available."
    return
  fi

  if ! command -v curl >/dev/null 2>&1; then
    log "Curl is required to install OpenCode. Please install curl and re-run this script."
    exit 1
  fi

  log "OpenCode CLI not found. Installing via official installer..."
  curl -fsSL https://opencode.ai/install | bash || {
    log "OpenCode installer failed. Please review the output above."
    exit 1
  }
  log "OpenCode CLI installation complete."
}

remote_validation() {
  if [ "$VALIDATE_REMOTE" != true ]; then
    return
  fi

  log "Validating remote repository availability..."
  if ! curl -fsSL "$REMOTE_MANIFEST" >/dev/null; then
    log "Remote validation failed. Cannot reach $REMOTE_MANIFEST"
    exit 1
  fi
  log "Remote repository is reachable."
}

backup_existing_config() {
  if [ -d "$TARGET_DIR" ]; then
    if [ "$DRY_RUN" = true ]; then
      log "Dry run: existing configuration would be archived to $BACKUP_PATH"
      return
    fi

    mkdir -p "$BACKUP_ROOT"
    log "Archiving existing configuration to $BACKUP_PATH"
    mv "$TARGET_DIR" "$BACKUP_PATH"
  fi
}

deploy_configuration() {
  if [ "$DRY_RUN" = true ]; then
    log "Dry run: configuration would be copied to $TARGET_DIR"
    return
  fi

  log "Deploying corporate configuration to $TARGET_DIR"
  mkdir -p "$TARGET_DIR"

  if command -v rsync >/dev/null 2>&1; then
    rsync -a --delete --exclude='.git' "$SCRIPT_DIR/" "$TARGET_DIR/"
  else
    tar -C "$SCRIPT_DIR" --exclude='.git' -cf - . | tar -C "$TARGET_DIR" -xf -
  fi

  log "Configuration deployment complete."
}

main() {
  parse_args "$@"
  detect_shell_rcfile
  ensure_aio_key
  log "Starting OpenCode Corporate Kit installer"
  if [ "$UPDATE_MODE" = true ]; then
    log "Update mode enabled. Ensuring there is an existing installation to refresh."
    if [ "$DRY_RUN" = true ]; then
      log "Dry run: skipping existence check."
    elif [ ! -d "$TARGET_DIR" ]; then
      log "Update mode requires an existing '~/.config/opencode' directory."
      exit 1
    fi
  fi
  ensure_opencode_cli
  remote_validation
  backup_existing_config
  deploy_configuration
  log "OpenCode Corporate Kit is ready in $TARGET_DIR"
  log "Run 'opencode' to begin using the new configuration."
}

main "$@"
