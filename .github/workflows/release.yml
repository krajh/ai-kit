name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#v}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Create tarball (runtime essentials only)
        id: tarball
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          TARBALL="ai-kit-${TAG}.tar.gz"

          # Create tarball with only runtime essentials
          tar -czf "${TARBALL}" \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='tests' \
            --exclude='*.tar.gz' \
            --exclude='*.bundle.json' \
            --exclude='TESTING_GUIDE.md' \
            --exclude='*_PLAN.md' \
            --exclude='*_CHECKLIST.md' \
            --exclude='*_MATRIX.md' \
            --exclude='protocols/rulesets' \
            --exclude='protocols/SECURITY_*' \
            --exclude='protocols/THREAT_*' \
            --exclude='bun.lock' \
            --exclude='tsconfig.json' \
            --exclude='package.json' \
            --exclude='ai-kit-install' \
            --exclude='install' \
            --exclude='README.md' \
            -C . \
            opencode.json \
            AGENTS.md \
            agent \
            skills \
            plugin \
            protocols/TOOL_USAGE_GUIDE.md \
            protocols/DELEGATION_PROTOCOLS.md

          SHA256=$(sha256sum "${TARBALL}" | awk '{print $1}')
          SIZE=$(stat -f%z "${TARBALL}" 2>/dev/null || stat -c%s "${TARBALL}")
          echo "tarball=${TARBALL}" >> $GITHUB_OUTPUT
          echo "sha256=${SHA256}" >> $GITHUB_OUTPUT
          echo "size=${SIZE}" >> $GITHUB_OUTPUT

      - name: Install cosign
        uses: sigstore/cosign-installer@v3
        with:
          cosign-release: "v2.4.1"

      - name: Sign tarball with cosign (keyless)
        id: cosign
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          BUNDLE="ai-kit-${TAG}.bundle.json"
          cosign sign-blob --yes --bundle "${BUNDLE}" "ai-kit-${TAG}.tar.gz"
          echo "bundle=${BUNDLE}" >> $GITHUB_OUTPUT

      - name: Create manifest.json
        id: manifest
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          VERSION="${{ steps.version.outputs.version }}"
          TARBALL="${{ steps.tarball.outputs.tarball }}"
          BUNDLE="${{ steps.cosign.outputs.bundle }}"
          SHA256="${{ steps.tarball.outputs.sha256 }}"
          SIZE="${{ steps.tarball.outputs.size }}"
          TIMESTAMP=$(date -u +'%Y-%m-%dT%H:%M:%SZ')

          cat > manifest.json <<EOF
          {
            "version": "${VERSION}",
            "tag": "${TAG}",
            "timestamp": "${TIMESTAMP}",
            "artifact": {
              "name": "${TARBALL}",
              "url": "https://github.com/krajh/ai-kit/releases/download/${TAG}/${TARBALL}",
              "sha256": "${SHA256}",
              "size": ${SIZE}
            },
            "signature": {
              "bundle_url": "https://github.com/krajh/ai-kit/releases/download/${TAG}/${BUNDLE}",
              "oidc_issuer": "https://token.actions.githubusercontent.com",
              "identity": "https://github.com/krajh/ai-kit/.github/workflows/release.yml@refs/tags/${TAG}"
            }
          }
          EOF

          echo "manifest=manifest.json" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            install
            ai-kit-install
            ${{ steps.tarball.outputs.tarball }}
            ${{ steps.cosign.outputs.bundle }}
            manifest.json
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
